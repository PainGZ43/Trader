# 상세 설계: 실행 (트레이딩) 모듈

## 1. 개요
이 모듈은 전략 엔진에서 생성된 **매매 신호(Signal)**를 실제 **주문(Order)**으로 변환하여 집행하고, 계좌의 **리스크(Risk)**를 관리하며, 사용자에게 **알림(Notification)**을 발송하는 역할을 수행합니다.

## 2. 핵심 컴포넌트

### 2.1. Order Manager (주문 관리자)
*   **역할**: 매매 신호를 받아 주문을 생성, 전송, 추적, 정정/취소합니다.
*   **주요 기능**:
    *   **주문 집행 (Execution)**:
        *   **시장가 (Market)**: 즉시 체결을 원할 때.
        *   **지정가 (Limit)**: 특정 가격에 도달했을 때 체결.
        *   **최유리 지정가 (Best Limit)**: 상대방 최우선 호가로 주문.
    *   **미체결 관리 (Open Order Management)**:
        *   일정 시간(예: 60초) 동안 체결되지 않으면 **취소**하거나 **호가 정정(Re-quote)**하여 재주문.
    *   **분할 매매 (Split Execution)**:
        *   대량 주문 시 시장 충격을 줄이기 위해 여러 번 나누어 주문 (TWAP/VWAP 로직 적용 가능).

### 2.2. Risk Manager (리스크 관리자)
*   **역할**: 주문이 나가기 전에 **안전장치** 역할을 수행합니다. (Gatekeeper).
*   **검사 항목 (Pre-Trade Checks)**:
    *   **자금 부족**: 주문 금액 > 예수금 인가?
    *   **일일 손실 한도**: 오늘 손실이 -3%를 넘었는가? (넘으면 매매 중단).
    *   **종목당 한도**: 한 종목에 몰빵(예: 비중 50% 초과)하려는가?
    *   **주문 횟수 제한**: 프로그램 오류로 인한 무한 주문 방지.

### 2.3. Notification System (알림 시스템)
*   **채널**: **KakaoTalk** (나에게 보내기 API).
*   **발송 이벤트**:
    *   **매매 체결**: "삼성전자 10주 매수 체결 (70,500원)".
    *   **에러 발생**: "API 연결 끊김! 재접속 시도 중...".
    *   **일일 리포트**: "오늘 수익률: +1.5% (수익금: 15,000원)".

## 3. 데이터 흐름 (Data Flow)
1.  `Strategy Engine` -> **Signal** (매수/삼성전자/70000원) -> `Risk Manager`
2.  `Risk Manager` -> **검증(Pass/Fail)** -> `Order Manager`
3.  `Order Manager` -> **REST API 요청** -> `Kiwoom Server`
4.  `Kiwoom Server` -> **체결 통보(WebSocket)** -> `Order Manager` -> `Notification System`

## 4. 테스트 계획 (Testing Plan)
# 상세 설계: 실행 (트레이딩) 모듈

## 1. 개요
이 모듈은 전략 엔진에서 생성된 **매매 신호(Signal)**를 실제 **주문(Order)**으로 변환하여 집행하고, 계좌의 **리스크(Risk)**를 관리하며, 사용자에게 **알림(Notification)**을 발송하는 역할을 수행합니다.

## 2. 핵심 컴포넌트

### 2.1. Order Manager (주문 관리자)
*   **역할**: 매매 신호를 받아 주문을 생성, 전송, 추적, 정정/취소합니다.
*   **주요 기능**:
    *   **주문 집행 (Execution)**:
        *   **시장가 (Market)**: 즉시 체결을 원할 때.
        *   **지정가 (Limit)**: 특정 가격에 도달했을 때 체결.
        *   **최유리 지정가 (Best Limit)**: 상대방 최우선 호가로 주문.
    *   **미체결 관리 (Open Order Management)**:
        *   일정 시간(예: 60초) 동안 체결되지 않으면 **취소**하거나 **호가 정정(Re-quote)**하여 재주문.
    *   **분할 매매 (Split Execution)**:
        *   대량 주문 시 시장 충격을 줄이기 위해 여러 번 나누어 주문 (TWAP/VWAP 로직 적용 가능).

### 2.2. Risk Manager (리스크 관리자)
*   **역할**: 주문이 나가기 전에 **안전장치** 역할을 수행합니다. (Gatekeeper).
*   **검사 항목 (Pre-Trade Checks)**:
    *   **자금 부족**: 주문 금액 > 예수금 인가?
    *   **일일 손실 한도**: 오늘 손실이 -3%를 넘었는가? (넘으면 매매 중단).
    *   **종목당 한도**: 한 종목에 몰빵(예: 비중 50% 초과)하려는가?
    *   **주문 횟수 제한**: 프로그램 오류로 인한 무한 주문 방지.

### 2.3. Notification System (알림 시스템)
*   **채널**: **KakaoTalk** (나에게 보내기 API).
*   **발송 이벤트**:
    *   **매매 체결**: "삼성전자 10주 매수 체결 (70,500원)".
    *   **에러 발생**: "API 연결 끊김! 재접속 시도 중...".
    *   **일일 리포트**: "오늘 수익률: +1.5% (수익금: 15,000원)".

## 3. 데이터 흐름 (Data Flow)
1.  `Strategy Engine` -> **Signal** (매수/삼성전자/70000원) -> `Risk Manager`
2.  `Risk Manager` -> **검증(Pass/Fail)** -> `Order Manager`
3.  `Order Manager` -> **REST API 요청** -> `Kiwoom Server`
4.  `Kiwoom Server` -> **체결 통보(WebSocket)** -> `Order Manager` -> `Notification System`

## 4. 테스트 계획 (Testing Plan)

### 4.1. 단위 테스트 (Unit Test)
*   **리스크 로직**: 잔고보다 큰 금액 주문 시 `Reject` 되는지 검증.
*   **주문 분할**: 100주 주문을 10주씩 10번으로 쪼개는지 로직 검증.

### 4.2. 시뮬레이션 테스트 (Simulation)
*   **가상 주문**: 실제 API를 통해 주문 전송 -> 체결 -> 잔고 변경 시나리오가 정상 작동하는지 확인.

## 5. 실행 모듈 심화 고려사항 (Advanced Considerations)

### 5.1. 부분 체결 (Partial Fills) 처리
*   **이슈**: 10주 주문했는데 3주만 체결되고 7주는 미체결 상태로 남음.
*   **해결**:
    *   `OrderTracker`가 주문의 상태를 `PartiallyFilled`로 관리.
    *   남은 수량에 대해 일정 시간 후 **시장가 전환** 또는 **취소** 로직 수행.

### 5.2. 수동 매매 동기화 (Manual Trade Sync)
*   **이슈**: 사용자가 HTS/MTS로 직접 매매하거나 물타기를 했을 때 프로그램이 이를 모르면 꼬임.
*   **해결**:
    *   실시간 체결 통보(WebSocket)는 HTS 주문 건도 들어옴.
    *   이를 감지하여 프로그램 내부의 `Position Manager` 상태를 강제로 동기화.

### 5.3. 키움 특화 에러 처리
*   **이슈**: "예수금 부족(OP_ERR_ORD_BUJOK)", "주문 가격 제한폭 초과" 등 에러 코드별 대응 필요.
*   **해결**:
    *   에러 코드 매핑 테이블을 만들어, 치명적 에러(계좌 동결 등)는 **프로그램 일시 정지** 및 **긴급 알림** 발송.
    *   일시적 에러(과부하)는 **지수 백오프(Exponential Backoff)** 후 재시도.

## 6. 운영 자동화 (Operational Automation)

### 6.1. 자동 로그인 및 스케줄링
*   **Auto Login**: 키움 번개(OpenAPI) 자동 로그인 설정(비밀번호 저장) 가이드 제공 및 프로세스 자동 실행.
*   **Scheduler**:
    *   **08:30**: 프로그램 자동 실행 및 업데이트 체크.
    *   **08:40**: API 로그인 및 접속 상태 확인.
    *   **08:50**: 데이터 수집기 가동 및 종목 마스터 동기화.
    *   **09:00**: 장 시작 (매매 로직 가동).
    *   **15:30**: 장 마감 (매매 중지, 당일 리포트 생성).
    *   **16:00**: 프로그램 자동 종료 (또는 절전 모드).

### 6.2. 헬스 체크 (Health Check)
*   **Heartbeat**: 메인 루프가 1분 이상 멈추면 별도의 `Watchdog` 프로세스가 이를 감지하여 프로그램 재시작 및 알림 발송.
